<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>رفع بلاغ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='create_ticket.css') }}">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>

<!-- Navbar موحد -->
<nav class="navbar">
    <div class="logo">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo">
    </div>

    <div class="nav-links">
        <a href="/my_tickets">بلاغاتي</a>
        <a class="active" href="/create_ticket">بلاغ جديد</a>
    </div>

    <div class="profile">
        <span class="user-name">{{ user_name }}</span>

        <a href="/logout" class="logout-btn" title="تسجيل الخروج">
            <i class="fa-solid fa-right-from-bracket"></i>
        </a>

        <div class="notification-wrapper" id="notifBell">
            <i class="fa fa-bell"></i>
            <span id="notifCount" class="notif-count" style="display:none;">0</span>

            <div id="notifDropdown" class="notif-dropdown">
                <p class="notif-title">التنبيهات</p>
                <div id="notifList"></div>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div class="form-card">
        <h2>رفع بلاغ جديد</h2>

        <form method="POST" action="/create_ticket">

            <label>عنوان البلاغ:</label>
            <input type="text" name="title" required>

            <label>وصف المشكلة:</label>
            <textarea name="description" required></textarea>

            <label>الفئة:</label>
            <select name="category" required>
                <option value="Software">Software</option>
                <option value="Hardware">Hardware</option>
                <option value="Network">Network</option>
                <option value="Data Science">Data Science</option>
                <option value="Cloud Computing">Cloud Computing</option>
                <option value="Other">Other</option>
            </select>

            <label>الأولوية:</label>
            <select name="priority" required>
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
            </select>

            <button type="submit" class="submit-btn">رفع البلاغ</button>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const bell       = document.getElementById("notifBell");
    const dropdown   = document.getElementById("notifDropdown");
    const notifList  = document.getElementById("notifList");
    const notifCount = document.getElementById("notifCount");

    if (!bell || !dropdown || !notifList || !notifCount) {
        console.error("أحد عناصر التنبيهات غير موجود في الصفحة");
        return;
    }

    bell.addEventListener("click", function (e) {
        e.stopPropagation();
        dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
    });

    document.addEventListener("click", function () {
        dropdown.style.display = "none";
    });

    loadNotifications();
    setInterval(loadNotifications, 5000);

    function loadNotifications() {
        fetch("/get_notifications")
            .then(res => res.json())
            .then(data => {

                notifList.innerHTML = "";

                if (data.count > 0) {
                    notifCount.style.display = "inline-block";
                    notifCount.innerText = data.count;
                } else {
                    notifCount.style.display = "none";
                    notifList.innerHTML = "<p>لا توجد تنبيهات</p>";
                    return;
                }

                data.notifications.forEach(n => {
                    let notifId  = n[0];
                    let ticketId = n[1];
                    let message  = n[2];

                    if (!ticketId) return;

                    let div = document.createElement("div");
                    div.className = "notif-item";
                    div.innerText = message;

                    div.onclick = () => {
                        fetch(`/mark_notification/${notifId}`);
                        window.location.href = `/chat/${ticketId}`;
                    };

                    notifList.appendChild(div);
                });
            });
    }
});
</script>

</body>
</html>
